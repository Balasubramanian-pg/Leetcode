# Unique Email Domain Analysis

## Overview

> [!NOTE]  
> This problem demonstrates how to extract and analyze email domains in SQL, focusing on `.com` domains with counting and sorting.

## 1. Problem Description

### 1.1 Table Structure

> [!TIP]  
> The Emails table contains email addresses that we'll parse to extract domain information.

```
+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| id          | int     |
| email       | varchar |
+-------------+---------+
```

> [!IMPORTANT]  
> We only consider domains ending with `.com` and need to count unique users per domain.

## 2. Solution Approach

### 2.1 Domain Extraction Concept

> [!TIP]  
> Using SUBSTRING_INDEX with '@' as delimiter efficiently extracts the domain portion from emails.

> [!WARNING]  
> The solution must correctly handle edge cases like emails without '@' or invalid formats.

### 2.2 SQL Solution

```sql
SELECT
    SUBSTRING_INDEX(email, '@', -1) AS email_domain,
    COUNT(*) AS count
FROM Emails
WHERE SUBSTRING_INDEX(email, '@', -1) LIKE '%.com'
GROUP BY email_domain
ORDER BY email_domain;
```

> [!NOTE]  
> This query extracts domains, filters for `.com`, counts users per domain, and sorts alphabetically.

## 3. Example Output

> [!EXAMPLE]  
> The output shows only `.com` domains with their respective user counts.

```
+--------------+-------+
| email_domain | count |
+--------------+-------+
| outlook.com  | 2     |
| yahoo.com    | 1     |
+--------------+-------+
```

## 4. Alternative Approaches

### 4.1 Using REGEXP for Domain Extraction

> [!TIP]  
> Regular expressions provide more flexible pattern matching for complex email formats.

```sql
SELECT
    REGEXP_SUBSTR(email, '@([^ ]+)') AS email_domain,
    COUNT(*) AS count
FROM Emails
WHERE email LIKE '%@%.com'
GROUP BY email_domain
ORDER BY email_domain;
```

### 4.2 Using RIGHT for Domain Validation

> [!NOTE]  
> This approach specifically checks the domain suffix.

```sql
SELECT
    SUBSTRING_INDEX(email, '@', -1) AS email_domain,
    COUNT(*) AS count
FROM Emails
WHERE RIGHT(email, 4) = '.com'
GROUP BY email_domain
ORDER BY email_domain;
```

## 5. Performance Considerations

> [!IMPORTANT]  
> For large datasets:
> - Add an index on the email column
> - Consider pre-filtering with a WHERE clause before extraction
> - Use persisted computed columns for domains in production systems

## 6. Common Mistakes

> [!CAUTION]  
> Forgetting to handle NULL emails or malformed addresses without '@' symbols.

> [!WARNING]  
> Case sensitivity issues - though the problem states emails are lowercase.

## 7. Real-World Application

> [!TIP]  
> Similar domain analysis is used for:
> - Customer segmentation
> - Email service provider evaluation
> - Marketing campaign targeting

## 8. Edge Cases

> [!NOTE]  
> The solution correctly handles:
> - Emails with multiple '@' symbols (takes last segment)
> - Very long domain names
> - Internationalized domain names (if supported by database)

## 9. Cross-Database Solutions

### 9.1 PostgreSQL Version

```sql
SELECT
    SPLIT_PART(email, '@', 2) AS email_domain,
    COUNT(*) AS count
FROM Emails
WHERE SPLIT_PART(email, '@', 2) LIKE '%.com'
GROUP BY email_domain
ORDER BY email_domain;
```

### 9.2 BigQuery Version

```sql
SELECT
    REGEXP_EXTRACT(email, r'@(.+)$') AS email_domain,
    COUNT(*) AS count
FROM Emails
WHERE REGEXP_EXTRACT(email, r'@(.+)$') LIKE '%.com'
GROUP BY email_domain
ORDER BY email_domain;
```
