# Combining Cities by State with String Aggregation

## Overview

> [!NOTE]  
> This problem demonstrates how to aggregate multiple string values into a single comma-separated list grouped by a category.

## 1. Problem Description

### 1.1 Table Structure

> [!TIP]  
> The cities table contains a simple mapping of cities to their respective states.

```
+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| state       | varchar |
| city        | varchar |
+-------------+---------+
```

> [!IMPORTANT]  
> We need to transform this normalized data into a denormalized format with comma-separated city lists.

## 2. Solution Approach

### 2.1 String Aggregation Concept

> [!TIP]  
> Using GROUP_CONCAT allows combining multiple rows into a single string with specified delimiters.

> [!WARNING]  
> Different databases have different string aggregation functions (STRING_AGG, LISTAGG, etc.)

### 2.2 SQL Solution (MySQL)

```sql
SELECT
    state,
    GROUP_CONCAT(city ORDER BY city SEPARATOR ', ') AS cities
FROM cities
GROUP BY state
ORDER BY state;
```

> [!NOTE]  
> The ORDER BY within GROUP_CONCAT ensures alphabetical city ordering within each state.

## 3. Example Output

> [!EXAMPLE]  
> Correctly combines cities while maintaining alphabetical order.

```
+-------------+---------------------------------------+
| state       | cities                                |
+-------------+---------------------------------------+
| California  | Los Angeles, San Diego, San Francisco |
| New York    | Buffalo, New York City, Rochester     |
| Texas       | Austin, Dallas, Houston               |
+-------------+---------------------------------------+
```

## 4. Alternative Approaches

### 4.1 PostgreSQL Version

```sql
SELECT
    state,
    STRING_AGG(city, ', ' ORDER BY city) AS cities
FROM cities
GROUP BY state
ORDER BY state;
```

### 4.2 SQL Server Version

```sql
SELECT
    state,
    STRING_AGG(city, ', ') WITHIN GROUP (ORDER BY city) AS cities
FROM cities
GROUP BY state
ORDER BY state;
```

## 5. Performance Considerations

> [!IMPORTANT]  
> For large datasets:
> - Be mindful of GROUP_CONCAT's group_concat_max_len setting
> - Consider indexing the state and city columns
> - For extremely large groups, batch processing may be needed

## 6. Common Mistakes

> [!CAUTION]  
> Forgetting to sort cities alphabetically within each state
> Omitting the SEPARATOR clause in MySQL's GROUP_CONCAT

## 7. Real-World Application

> [!TIP]  
> Similar string aggregation is used for:
> - Generating reports with grouped data
> - Creating comma-separated lists in applications
> - Data transformation for analytics

## 8. Edge Cases

> [!NOTE]  
> The solution handles:
> - States with a single city
> - Very long city names
> - Special characters in city names

## 9. Function Variations

### 9.1 Oracle Version

```sql
SELECT
    state,
    LISTAGG(city, ', ') WITHIN GROUP (ORDER BY city) AS cities
FROM cities
GROUP BY state
ORDER BY state;
```

### 9.2 SQLite Version

```sql
SELECT
    state,
    GROUP_CONCAT(city, ', ') AS cities
FROM (
    SELECT state, city
    FROM cities
    ORDER BY state, city
)
GROUP BY state;
```

## 10. Custom Formatting Options

To include the state abbreviation before each city:

```sql
-- MySQL example
SELECT
    state,
    GROUP_CONCAT(CONCAT(state_abbr, ' - ', city) ORDER BY city SEPARATOR '; ') AS cities
FROM cities
JOIN states USING (state)
GROUP BY state
ORDER BY state;
```
